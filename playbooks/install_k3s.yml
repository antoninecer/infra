---
#################################################
# BASE PREREQS â€“ ALL NODES
#################################################

- name: Base prereqs
  hosts: k8s
  become: true
  tasks:

    - name: Disable swap
      command: swapoff -a
      when: ansible_facts['swaptotal_mb'] > 0

    - name: Disable swap in fstab
      replace:
        path: /etc/fstab
        regexp: '^(.*\sswap\s.*)$'
        replace: '# \1'

    - name: Load kernel modules config
      copy:
        dest: /etc/modules-load.d/k3s.conf
        content: |
          overlay
          br_netfilter

    - name: Load modules now
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Sysctl config
      copy:
        dest: /etc/sysctl.d/k3s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl
      command: sysctl --system
      changed_when: false

    - name: Ensure curl exists
      apt:
        name: curl
        state: present
        update_cache: yes


#################################################
# FIRST MASTER (cluster-init)
#################################################

- name: Install first K3s server
  hosts: k8s01m01
  become: true
  vars:
    k3s_version: "v1.29.7+k3s1"
    api_ip: "192.168.15.10"
  tasks:

    - name: Check if k3s already installed
      stat:
        path: /etc/systemd/system/k3s.service
      register: k3s_service

    - name: Install K3s cluster-init
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          sh -s - server \
            --cluster-init \
            --tls-san {{ api_ip }} \
            --write-kubeconfig-mode 644
      when: not k3s_service.stat.exists

    - name: Wait for token
      wait_for:
        path: /var/lib/rancher/k3s/server/node-token
        timeout: 60

    - name: Read token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: token_raw

    - name: Save token fact
      set_fact:
        k3s_token: "{{ token_raw.content | b64decode | trim }}"

    - name: Ensure kube dir
      file:
        path: /root/.kube
        state: directory
        mode: '0700'

    - name: Copy kubeconfig
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /root/.kube/config
        remote_src: true


#################################################
# OTHER MASTERS
#################################################

- name: Join additional masters
  hosts: control_plane:!k8s01m01
  become: true
  vars:
    k3s_version: "v1.29.7+k3s1"
    api_ip: "192.168.15.10"
  tasks:

    - name: Check if installed
      stat:
        path: /etc/systemd/system/k3s.service
      register: k3s_service

    - name: Install K3s master join
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          K3S_URL="https://{{ api_ip }}:6443" \
          K3S_TOKEN="{{ hostvars['k8s01m01'].k3s_token }}" \
          sh -s - server
      when: not k3s_service.stat.exists


#################################################
# WORKERS
#################################################

- name: Join workers
  hosts: workers
  become: true
  vars:
    k3s_version: "v1.29.7+k3s1"
    api_ip: "192.168.15.10"
  tasks:

    - name: Check if agent installed
      stat:
        path: /etc/systemd/system/k3s-agent.service
      register: k3s_agent

    - name: Install K3s agent
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          K3S_URL="https://{{ api_ip }}:6443" \
          K3S_TOKEN="{{ hostvars['k8s01m01'].k3s_token }}" \
          sh -s - agent
      when: not k3s_agent.stat.exists

