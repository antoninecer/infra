---
- name: Base prereqs on all k8s nodes
  hosts: k8s
  become: true
  tasks:
    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab

    - name: Load kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Enable kernel modules now
      shell: |
        modprobe overlay
        modprobe br_netfilter

    - name: Sysctl for k8s
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl
      command: sysctl --system

    - name: Ensure curl is installed
      apt:
        name: curl
        state: present
        update_cache: yes


- name: Install first K3s server (cluster-init)
  hosts: k8s01m01
  become: true
  vars:
    k3s_version: "v1.29.7+k3s1"
    k3s_tls_san: "192.168.15.10"
  tasks:
    - name: Install K3s server (cluster-init)
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          sh -s - server \
            --cluster-init \
            --tls-san "{{ k3s_tls_san }}" \
            --write-kubeconfig-mode 644
      args:
        creates: /etc/systemd/system/k3s.service

    - name: Read node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token_raw

    - name: Set token fact
      set_fact:
        k3s_token: "{{ node_token_raw.content | b64decode | trim }}"

    - name: Save kubeconfig for later use on this node
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /root/.kube/config
        remote_src: true
      vars:
        ansible_python_interpreter: /usr/bin/python3
      ignore_errors: true


- name: Join additional K3s servers (HA masters)
  hosts: control_plane:!k8s01m01
  become: true
  vars:
    k3s_version: "v1.29.7+k3s1"
    k3s_url: "https://192.168.15.10:6443"
  tasks:
    - name: Install K3s server (join)
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          K3S_URL="{{ k3s_url }}" \
          K3S_TOKEN="{{ hostvars['k8s01m01'].k3s_token }}" \
          sh -s - server
      args:
        creates: /etc/systemd/system/k3s.service


- name: Join K3s agents (workers)
  hosts: workers
  become: true
  vars:
    k3s_version: "v1.29.7+k3s1"
    k3s_url: "https://192.168.15.10:6443"
  tasks:
    - name: Install K3s agent (join)
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          K3S_URL="{{ k3s_url }}" \
          K3S_TOKEN="{{ hostvars['k8s01m01'].k3s_token }}" \
          sh -s - agent
      args:
        creates: /etc/systemd/system/k3s-agent.service

